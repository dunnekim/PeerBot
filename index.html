
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PeerBot - KOSPI 200 Screener</title>
    
    <!-- 1. Libraries (React, Tailwind, Recharts) -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Recharts Dependencies -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js" crossorigin></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js" crossorigin></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
              slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' }
            }
          },
        },
      }
    </script>
    <style>
      body { background-color: #0f172a; color: #e2e8f0; }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #1e293b; }
      ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #64748b; }
      .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "react-router-dom": "https://aistudiocdn.com/react-router-dom@^7.9.6",
    "recharts": "https://aistudiocdn.com/recharts@^3.5.1"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- GLOBAL SETUP ---
        const { useState, useEffect, useMemo } = React;
        const ReactDOM = window.ReactDOM;
        
        // Recharts Safe Loading
        const RechartsObj = window.Recharts || {};
        const { ResponsiveContainer, BarChart, Bar, XAxis, Tooltip, Cell } = RechartsObj;
        const SafeResponsiveContainer = ResponsiveContainer || (({children}) => <div>{children}</div>);
        const SafeBarChart = BarChart || (({children}) => <div>Chart Error</div>);
        const SafeBar = Bar || (() => null);
        const SafeXAxis = XAxis || (() => null);
        const SafeTooltip = Tooltip || (() => null);

        // --- ICONS (SVG) ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
            Sliders: (p) => <Icon {...p} path={<><line x1="4" x2="20" y1="21" y2="21"/><line x1="4" x2="20" y1="14" y2="14"/><line x1="4" x2="20" y1="7" y2="7"/><circle cx="12" cy="14" r="2"/><circle cx="12" cy="7" r="2"/><circle cx="12" cy="21" r="2"/></>} />,
            Cpu: (p) => <Icon {...p} path={<><rect width="16" height="16" x="4" y="4" rx="2"/><rect width="6" height="6" x="9" y="9" rx="1"/><path d="M15 2v2"/><path d="M15 20v2"/><path d="M2 15h2"/><path d="M2 9h2"/><path d="M20 15h2"/><path d="M20 9h2"/><path d="M9 2v2"/><path d="M9 20v2"/></>} />,
            Zap: (p) => <Icon {...p} path={<><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></>} />,
            Brain: (p) => <Icon {...p} path={<><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-3.465"/><path d="M19.97 14.535A4 4 0 0 1 18 18"/></>} />,
            Filter: (p) => <Icon {...p} path={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            TrendingUp: (p) => <Icon {...p} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>} />,
            AlertTriangle: (p) => <Icon {...p} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />,
            ChevronRight: (p) => <Icon {...p} path={<><path d="m9 18 6-6-6-6"/></>} />,
            ChevronLeft: (p) => <Icon {...p} path={<><path d="m15 18-6-6 6-6"/></>} />,
            FileText: (p) => <Icon {...p} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></>} />,
            Activity: (p) => <Icon {...p} path={<><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></>} />,
            Key: (p) => <Icon {...p} path={<><path d="m21 2-2 2m-7.6 7.6a6.5 6.5 0 1 1-5.3-5.3"/><circle cx="8" cy="8" r="3"/><path d="M7 17v5"/><path d="M12 17v2"/><path d="M17 12v5"/></>} />,
            Bot: (p) => <Icon {...p} path={<><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></>} />
        };

        // --- KOSPI 200 DATA (Processed & Embedded) ---
        // 단위 변환: 원본 데이터(백만 원) -> 앱 표준(억 원)으로 변환 (/100)
        const MOCK_DATA = [
            { corp_name: "삼성전자", stock_code: "005930", market: "KOSPI", sector: "전기전자", market_cap: 3539640, sales: 3008709, ebitda: 741403, per: 12.5, biz_description_raw: "DX부문(모바일, TV), DS부문(메모리, 시스템LSI, 파운드리), SDC, Harman으로 구성. 글로벌 메모리 반도체 시장 점유율 1위." },
            { corp_name: "SK하이닉스", stock_code: "000660", market: "KOSPI", sector: "전기전자", market_cap: 1198238, sales: 661929, ebitda: 354046, per: 11.6, biz_description_raw: "DRAM, NAND Flash, MCP 등 메모리 반도체 생산 및 판매. AI 서버용 고대역폭 메모리(HBM) 시장 선도." },
            { corp_name: "LG에너지솔루션", stock_code: "373220", market: "KOSPI", sector: "전기전자", market_cap: 814320, sales: 256195, ebitda: 33891, per: 31.7, biz_description_raw: "전기차 배터리, ESS, 소형 배터리 제조. 글로벌 배터리 시장 점유율 상위권." },
            { corp_name: "현대차", stock_code: "005380", market: "KOSPI", sector: "운수장비", market_cap: 465580, sales: 1752311, ebitda: 173918, per: 4.2, biz_description_raw: "자동차 및 부품 제조·판매. 제네시스, 아이오닉 등 전기차 및 고급차 라인업 확대." },
            { corp_name: "기아", stock_code: "000270", market: "KOSPI", sector: "운수장비", market_cap: 392377, sales: 1074487, ebitda: 152165, per: 4.1, biz_description_raw: "승용차, SUV, MPV, 상용차 제조. EV6, EV9 등 전동화 전환 가속." },
            { corp_name: "셀트리온", stock_code: "068270", market: "KOSPI", sector: "의약품", market_cap: 403654, sales: 35573, ebitda: 9102, per: 200.8, biz_description_raw: "바이오시밀러(램시마, 트룩시마, 짐펜트라 등) 개발 및 생산. 글로벌 바이오의약품 시장 판매." },
            { corp_name: "POSCO홀딩스", stock_code: "005490", market: "KOSPI", sector: "철강금속", market_cap: 190710, sales: 726881, ebitda: 61071, per: 16.8, biz_description_raw: "철강 생산 및 2차전지 소재(리튬, 니켈) 사업 지주사." },
            { corp_name: "NAVER", stock_code: "035420", market: "KOSPI", sector: "서비스업", market_cap: 300826, sales: 107377, ebitda: 26527, per: 18.0, biz_description_raw: "국내 1위 검색 포털. 커머스, 핀테크, 웹툰, 클라우드 및 AI(HyperCLOVA X) 사업 영위." },
            { corp_name: "삼성물산", stock_code: "028260", market: "KOSPI", sector: "유통업", market_cap: 187449, sales: 421032, ebitda: 39034, per: 8.9, biz_description_raw: "건설, 상사, 패션, 리조트, 식음료, 바이오 등 다각화된 사업 포트폴리오 보유." },
            { corp_name: "KB금융", stock_code: "105560", market: "KOSPI", sector: "금융업", market_cap: 310452, sales: 0, ebitda: 0, per: 7.2, biz_description_raw: "국민은행 등 자회사를 둔 국내 최대 금융지주회사." },
            { corp_name: "신한지주", stock_code: "055550", market: "KOSPI", sector: "금융업", market_cap: 239891, sales: 0, ebitda: 0, per: 5.5, biz_description_raw: "신한은행, 신한카드 등을 보유한 종합 금융 그룹." },
            { corp_name: "현대모비스", stock_code: "012330", market: "KOSPI", sector: "운수장비", market_cap: 213661, sales: 572369, ebitda: 40583, per: 6.2, biz_description_raw: "자동차 모듈 및 핵심 부품 제조, AS 부품 공급. 전동화 부품 사업 확대." },
            { corp_name: "카카오", stock_code: "035720", market: "KOSPI", sector: "서비스업", market_cap: 167663, sales: 78716, ebitda: 12823, per: 20.0, biz_description_raw: "국민 메신저 카카오톡 기반 플랫폼. 모빌리티, 페이, 게임, 웹툰 등 다양한 서비스." },
            { corp_name: "하나금융지주", stock_code: "086790", market: "KOSPI", sector: "금융업", market_cap: 160687, sales: 0, ebitda: 0, per: 4.6, biz_description_raw: "하나은행, 하나증권 등을 보유한 글로벌 금융 그룹." },
            { corp_name: "삼성생명", stock_code: "032830", market: "KOSPI", sector: "보험", market_cap: 170236, sales: 286877, ebitda: 18782, per: 6.8, biz_description_raw: "국내 최대 생명보험사. 보험, 대출, 퇴직연금 및 자산운용업 영위." },
            { corp_name: "LG전자", stock_code: "066570", market: "KOSPI", sector: "전기전자", market_cap: 143087, sales: 877281, ebitda: 69535, per: 19.4, biz_description_raw: "생활가전(H&A), TV(HE), 전장부품(VS) 등 글로벌 가전 및 전장 기업." },
            { corp_name: "메리츠금융지주", stock_code: "138040", market: "KOSPI", sector: "금융업", market_cap: 187080, sales: 0, ebitda: 0, per: 8.5, biz_description_raw: "화재, 증권 등 금융 자회사를 둔 지주회사. 높은 주주환원 정책." },
            { corp_name: "SK이노베이션", stock_code: "096770", market: "KOSPI", sector: "화학", market_cap: 166163, sales: 747169, ebitda: 24776, per: 20.0, biz_description_raw: "석유 정제, 화학, 윤활유 및 배터리(SK온) 사업을 영위하는 에너지 기업." },
            { corp_name: "한국전력", stock_code: "015760", market: "KOSPI", sector: "전기가스", market_cap: 128713, sales: 933988, ebitda: 217098, per: 3.5, biz_description_raw: "국내 전력 생산, 송전, 배전 및 판매를 담당하는 공기업." },
            { corp_name: "HMM", stock_code: "011200", market: "KOSPI", sector: "운수창고", market_cap: 155591, sales: 117002, ebitda: 44156, per: 5.8, biz_description_raw: "컨테이너선 및 벌크선 해상 운송 서비스 제공." },
            { corp_name: "크래프톤", stock_code: "259960", market: "KOSPI", sector: "서비스업", market_cap: 142069, sales: 27097, ebitda: 12883, per: 18.0, biz_description_raw: "배틀그라운드(PUBG) IP 기반의 글로벌 게임 개발사." },
            { corp_name: "두산에너빌리티", stock_code: "034020", market: "KOSPI", sector: "기계", market_cap: 112401, sales: 162330, ebitda: 14831, per: 136.7, biz_description_raw: "원자력, 풍력, 가스터빈 등 발전 설비 제작 및 시공. SMR 사업 확대." },
            { corp_name: "포스코인터내셔널", stock_code: "047050", market: "KOSPI", sector: "유통업", market_cap: 67581, sales: 323407, ebitda: 16070, per: 10.1, biz_description_raw: "종합상사. 에너지(LNG), 철강, 식량, 친환경 부품 사업 영위." },
            { corp_name: "KT", stock_code: "030200", market: "KOSPI", sector: "통신업", market_cap: 107794, sales: 264312, ebitda: 42373, per: 9.3, biz_description_raw: "유무선 통신, 미디어, AI, 클라우드, IDC 등 DIGICO 전환 추진." },
            { corp_name: "SK텔레콤", stock_code: "017670", market: "KOSPI", sector: "통신업", market_cap: 117513, sales: 179755, ebitda: 50565, per: 10.6, biz_description_raw: "국내 1위 이동통신사. AI 피라미드 전략으로 AI 컴퍼니 도약." },
            { corp_name: "우리금융지주", stock_code: "316140", market: "KOSPI", sector: "금융업", market_cap: 114128, sales: 0, ebitda: 0, per: 4.4, biz_description_raw: "우리은행, 우리카드 등을 보유한 종합 금융 그룹." },
            { corp_name: "기업은행", stock_code: "024110", market: "KOSPI", sector: "은행", market_cap: 114271, sales: 0, ebitda: 0, per: 4.7, biz_description_raw: "중소기업 지원을 목적으로 설립된 국책은행." },
            { corp_name: "한화오션", stock_code: "042660", market: "KOSPI", sector: "운수장비", market_cap: 114439, sales: 107760, ebitda: 4182, per: 56.1, biz_description_raw: "LNG선, 잠수함 등 특수선 건조 경쟁력 보유 조선사." },
            { corp_name: "HD현대중공업", stock_code: "329180", market: "KOSPI", sector: "운수장비", market_cap: 255222, sales: 144864, ebitda: 10040, per: 89.3, biz_description_raw: "글로벌 1위 조선사. 선박, 해양플랜트, 엔진기계 사업 영위." },
            { corp_name: "삼성화재", stock_code: "000810", market: "KOSPI", sector: "보험", market_cap: 150144, sales: 195342, ebitda: 27773, per: 8.4, biz_description_raw: "국내 1위 손해보험사. 자동차, 장기, 일반 보험 상품 제공." },
            { corp_name: "LG화학", stock_code: "051910", market: "KOSPI", sector: "화학", market_cap: 188681, sales: 489161, ebitda: 55783, per: 20.0, biz_description_raw: "석유화학, 첨단소재, 생명과학 사업. LG에너지솔루션의 모회사." },
            { corp_name: "S-Oil", stock_code: "010950", market: "KOSPI", sector: "화학", market_cap: 63157, sales: 366370, ebitda: 11741, per: 94.0, biz_description_raw: "사우디 아람코 자회사. 정유, 윤활기유, 석유화학 사업 영위." },
            { corp_name: "SK스퀘어", stock_code: "402340", market: "KOSPI", sector: "서비스업", market_cap: 105731, sales: 100047, ebitda: 41413, per: 6.3, biz_description_raw: "SK하이닉스 등을 자회사로 둔 반도체 및 ICT 투자 전문 회사." },
            { corp_name: "삼성SDS", stock_code: "018260", market: "KOSPI", sector: "서비스업", market_cap: 98853, sales: 138282, ebitda: 15185, per: 13.9, biz_description_raw: "IT 서비스, 클라우드, 물류 BPO 사업. 생성형 AI 솔루션 제공." },
            { corp_name: "대한항공", stock_code: "003490", market: "KOSPI", sector: "운수창고", market_cap: 83470, sales: 178707, ebitda: 38857, per: 7.7, biz_description_raw: "국내 최대 항공사. 여객 및 화물 운송, 항공우주 사업 영위." },
            { corp_name: "하이브", stock_code: "352820", market: "KOSPI", sector: "서비스업", market_cap: 80555, sales: 22556, ebitda: 3302, per: 35.0, biz_description_raw: "글로벌 엔터테인먼트 라이프스타일 플랫폼. BTS, 세븐틴 등 아티스트 보유." },
            { corp_name: "카카오뱅크", stock_code: "323410", market: "KOSPI", sector: "은행", market_cap: 100401, sales: 0, ebitda: 0, per: 23.3, biz_description_raw: "100% 모바일 기반 인터넷 전문 은행." },
            { corp_name: "삼성전기", stock_code: "009150", market: "KOSPI", sector: "전기전자", market_cap: 91604, sales: 102941, ebitda: 15753, per: 19.0, biz_description_raw: "MLCC, 카메라모듈, 반도체 패키지기판 제조." },
            { corp_name: "고려아연", stock_code: "010130", market: "KOSPI", sector: "철강금속", market_cap: 182725, sales: 120529, ebitda: 10769, per: 33.0, biz_description_raw: "글로벌 비철금속 제련 기업. 아연, 연, 금, 은 등 생산." },
            { corp_name: "한화에어로스페이스", stock_code: "012450", market: "KOSPI", sector: "운수장비", market_cap: 148448, sales: 112401, ebitda: 19300, per: 21.9, biz_description_raw: "항공우주 및 방위산업. K9 자주포, 레드백 장갑차, 우주 발사체 등." },
            { corp_name: "HD현대일렉트릭", stock_code: "267260", market: "KOSPI", sector: "전기전자", market_cap: 137492, sales: 33223, ebitda: 7342, per: 26.9, biz_description_raw: "변압기, 고압차단기 등 전력기기 및 에너지 솔루션 제공." },
            { corp_name: "SK바이오팜", stock_code: "326030", market: "KOSPI", sector: "의약품", market_cap: 87006, sales: 5475, ebitda: 1137, per: 151.6, biz_description_raw: "중추신경계 질환 신약 개발. 뇌전증 치료제 엑스코프리 글로벌 판매." },
            { corp_name: "삼성바이오로직스", stock_code: "207940", market: "KOSPI", sector: "의약품", market_cap: 675441, sales: 45473, ebitda: 19191, per: 64.2, biz_description_raw: "글로벌 1위 바이오 의약품 위탁개발생산(CDMO) 기업." },
            { corp_name: "아모레퍼시픽", stock_code: "090430", market: "KOSPI", sector: "화학", market_cap: 64613, sales: 38851, ebitda: 4778, per: 10.9, biz_description_raw: "설화수, 라네즈 등 브랜드를 보유한 글로벌 뷰티 기업." },
            { corp_name: "LG이노텍", stock_code: "011070", market: "KOSPI", sector: "전기전자", market_cap: 38336, sales: 212007, ebitda: 19860, per: 5.5, biz_description_raw: "모바일 카메라모듈, 반도체 기판, 전장부품 제조." },
            { corp_name: "한미반도체", stock_code: "042700", market: "KOSPI", sector: "전기전자", market_cap: 78999, sales: 5589, ebitda: 2651, per: 43.9, biz_description_raw: "반도체 후공정 장비 제조. HBM용 TC 본더 글로벌 점유율 1위." },
            { corp_name: "유한양행", stock_code: "000100", market: "KOSPI", sector: "의약품", market_cap: 89436, sales: 20677, ebitda: 1179, per: 56.7, biz_description_raw: "렉라자 등 신약 개발 및 전문의약품, 생활용품 사업 영위." },
            { corp_name: "DB손해보험", stock_code: "005830", market: "KOSPI", sector: "보험", market_cap: 61724, sales: 183180, ebitda: 15682, per: 3.1, biz_description_raw: "자동차보험, 장기보험 등을 주력으로 하는 대형 손해보험사." },
            { corp_name: "미래에셋증권", stock_code: "006800", market: "KOSPI", sector: "증권", market_cap: 40128, sales: 148153, ebitda: 0, per: 16.1, biz_description_raw: "국내 최대 자기자본을 보유한 글로벌 투자은행." }
        ];

        // --- SERVICE LOGIC ---
        // OpMargin 계산 (EBITDA를 영업이익 대용으로 사용)
        const getOpMargin = (c) => c.sales === 0 ? 0 : ((c.ebitda / c.sales) * 100);

        const KEYWORD_TRANSLATIONS = {
            '반도체': ['Semiconductor', 'Memory', 'Chip', 'Foundry', 'HBM', '전기전자'],
            '배터리': ['Battery', 'Cathode', 'Anode', 'EV', 'Energy', '2차전지', '화학'],
            '자동차': ['Auto', 'Vehicle', 'Car', 'Mobility', '운수장비'],
            '플랫폼': ['Platform', 'Internet', 'Service', 'App', '서비스업', 'NAVER', 'Kakao'],
            '게임': ['Game', 'Gaming', '서비스업', '크래프톤', '넷마블'],
            '바이오': ['Bio', 'Pharmaceutical', 'Drug', '의약품', '헬스케어'],
            '금융': ['Financial', 'Bank', 'Insurance', '금융업', '은행', '증권', '보험'],
            '방산': ['Defense', 'Aerospace', 'Weapon', '운수장비', '한화에어로스페이스'],
            '조선': ['Ship', 'Marine', 'Vessel', '운수장비', 'HD현대', '한화오션'],
            '지주': ['Holdings', '지주사']
        };

        const parseSmartQuery = (query) => {
            const conditions = { minSales: 0, minOpMargin: 0, targetMarket: null, sizeCategory: null, keywords: [] };
            
            // "매출 10조" -> 100000 (억 단위 변환)
            const salesMatch = query.match(/(?:매출|매출액|sales)[^\d]*(\d+)(?:조|t|tn)?/i);
            if (salesMatch) {
                let val = parseFloat(salesMatch[1]);
                if(query.includes("조")) val *= 10000; // 1조 = 10,000억
                conditions.minSales = val;
            }

            // "마진율 10%"
            const marginMatch = query.match(/(?:마진|이익률|영업이익|ebitda)[^\d]*(\d+(?:\.\d+)?)/i);
            if (marginMatch) conditions.minOpMargin = parseFloat(marginMatch[1]);

            if (query.match(/kospi|코스피/i)) conditions.targetMarket = 'KOSPI';
            if (query.match(/kosdaq|코스닥/i)) conditions.targetMarket = 'KOSDAQ';

            if (query.match(/대형|large/i)) conditions.sizeCategory = 'LARGE';
            else if (query.match(/중형|mid/i)) conditions.sizeCategory = 'MID';
            else if (query.match(/소형|small/i)) conditions.sizeCategory = 'SMALL';

            // Clean keywords
            let cleanQuery = query
                .replace(/(?:매출|매출액|sales)[^\d]*(\d+)(?:조|억|t|tn)?(?:이상|넘|초과)?/ig, '')
                .replace(/(?:마진|이익률|영업이익|ebitda)[^\d]*(\d+(?:\.\d+)?)(?:%|프로)?(?:이상|넘|초과)?/ig, '')
                .replace(/kospi|코스피|kosdaq|코스닥/ig, '')
                .replace(/대형|중형|소형/ig, '')
                .replace(/이상|초과|넘는|인|의|가|이|은|는|기업|회사|주식/g, '')
                .trim();
            
            const rawKeywords = cleanQuery.split(/[\s,]+/).filter(k => k.length > 0 && !k.match(/^[0-9]+$/));
            const expanded = [];
            rawKeywords.forEach(k => {
                expanded.push(k);
                if (KEYWORD_TRANSLATIONS[k]) expanded.push(...KEYWORD_TRANSLATIONS[k]);
            });
            conditions.keywords = expanded;
            return conditions;
        };

        const filterCompanies = (companies, filter) => {
            let result = companies;
            let effSales = filter.minSales;
            let effMargin = filter.minOpMargin;
            let effMarket = filter.market;
            let keywords = [];
            let sizeFilter = filter.size;

            if (filter.mode === 'SMART' && filter.keyword) {
                const parsed = parseSmartQuery(filter.keyword);
                effSales = Math.max(effSales, parsed.minSales);
                effMargin = Math.max(effMargin, parsed.minOpMargin);
                if (parsed.targetMarket) effMarket = parsed.targetMarket;
                if (parsed.sizeCategory) sizeFilter = parsed.sizeCategory;
                keywords = parsed.keywords;
            } else if (filter.keyword) {
                keywords = [filter.keyword];
            }

            if (effMarket !== 'ALL') result = result.filter(c => c.market === effMarket);
            if (effSales > 0) result = result.filter(c => c.sales >= effSales);
            if (effMargin > 0) result = result.filter(c => getOpMargin(c) >= effMargin);
            
            if (sizeFilter === 'LARGE') result = result.filter(c => c.market_cap >= 100000); // 10조 이상
            else if (sizeFilter === 'MID') result = result.filter(c => c.market_cap >= 10000 && c.market_cap < 100000);
            else if (sizeFilter === 'SMALL') result = result.filter(c => c.market_cap < 10000);

            if (keywords.length > 0) {
                result = result.filter(c => {
                    const txt = `${c.corp_name} ${c.stock_code} ${c.sector} ${c.biz_description_raw}`.toLowerCase();
                    return keywords.some(kw => txt.includes(kw.toLowerCase()));
                });
            }
            return result;
        };

        // --- COMPONENTS ---

        const SearchBar = ({ value, mode, onChange, onModeChange, onToggleFilters }) => (
            <div className="relative max-w-2xl mx-auto mb-8 group">
                <div className={`absolute -inset-1 bg-gradient-to-r rounded-xl opacity-20 group-hover:opacity-40 blur transition duration-200 ${mode === 'SMART' ? 'from-emerald-500 to-cyan-500' : 'from-blue-500 to-indigo-500'}`}></div>
                <div className="relative flex flex-col gap-2">
                    <div className="relative flex items-center bg-slate-900 border border-slate-700 rounded-xl shadow-2xl overflow-hidden">
                        <div className="pl-4 text-slate-400"><Icons.Search className="w-5 h-5" /></div>
                        <input
                            type="text" value={value} onChange={(e) => onChange(e.target.value)}
                            placeholder={mode === 'SMART' ? "예: 매출 10조 이상인 반도체 기업 (자연어 처리)" : "기업명, 코드, 업종으로 검색..."}
                            className="w-full bg-transparent border-none py-4 px-3 text-lg text-white placeholder-slate-500 focus:ring-0 focus:outline-none"
                        />
                        <div className="flex items-center border-l border-slate-800">
                            <button onClick={onToggleFilters} className="p-4 text-slate-400 hover:text-white hover:bg-slate-800 transition-colors" title="필터 설정">
                                <Icons.Sliders className="w-5 h-5" />
                            </button>
                        </div>
                    </div>
                    <div className="flex justify-between items-center px-1">
                        <div className="flex items-center bg-slate-800/50 p-1 rounded-lg border border-slate-700/50">
                            <button onClick={() => onModeChange('FAST')} className={`flex items-center gap-1.5 px-3 py-1 rounded-md text-xs font-medium transition-all ${mode === 'FAST' ? 'bg-indigo-500 text-white shadow-lg' : 'text-slate-400 hover:text-slate-300'}`}>
                                <Icons.Zap className="w-3 h-3" /> 빠른 검색
                            </button>
                            <button onClick={() => onModeChange('SMART')} className={`flex items-center gap-1.5 px-3 py-1 rounded-md text-xs font-medium transition-all ${mode === 'SMART' ? 'bg-emerald-500 text-white shadow-lg' : 'text-slate-400 hover:text-slate-300'}`}>
                                <Icons.Brain className="w-3 h-3" /> 스마트 검색
                            </button>
                        </div>
                        <div className="text-xs text-slate-500">
                            {mode === 'SMART' ? <span>팁: <span className="text-emerald-400">"마진율 10% 이상 대형주"</span></span> : <span>단순 텍스트 매칭</span>}
                        </div>
                    </div>
                </div>
            </div>
        );

        const DetailPanel = ({ company, onClose }) => {
            const [analysis, setAnalysis] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [apiKey, setApiKey] = useState("");

            useEffect(() => { setAnalysis(null); setError(null); }, [company]);

            const handleAnalyze = async () => {
                if (!apiKey) { setError("Gemini API 키를 먼저 입력해주세요."); return; }
                setLoading(true); setError(null);
                
                try {
                    const prompt = `You are an expert financial analyst. Analyze this business description. Return ONLY raw JSON with keys: summary(string, korean), strengths(array, korean), risks(array, korean). Description: ${company.biz_description_raw}`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                    });
                    if (!response.ok) throw new Error("API call failed");
                    const data = await response.json();
                    setAnalysis(JSON.parse(data.candidates[0].content.parts[0].text));
                } catch (err) {
                    setError("분석 실패. API Key를 확인하세요.");
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            const chartData = [ { name: '매출', value: company.sales }, { name: '시총', value: company.market_cap }, { name: 'EBITDA', value: company.ebitda } ];
            const opMargin = getOpMargin(company).toFixed(1);

            return (
                <div className="fixed inset-y-0 right-0 w-full md:w-[600px] bg-slate-900 border-l border-slate-800 shadow-2xl z-50 overflow-y-auto animate-fade-in">
                    <div className="sticky top-0 bg-slate-900/90 backdrop-blur z-10 border-b border-slate-800 p-6 flex items-start justify-between">
                        <div>
                            <div className="flex items-center gap-3">
                                <h2 className="text-2xl font-bold text-white">{company.corp_name}</h2>
                                <span className="text-sm font-mono text-slate-400 bg-slate-800 px-2 py-1 rounded">{company.stock_code}</span>
                            </div>
                            <p className="text-emerald-400 font-medium mt-1">{company.sector} | {company.market}</p>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white"><Icons.X className="w-6 h-6" /></button>
                    </div>

                    <div className="p-6 space-y-8">
                        <div className="bg-slate-950 p-6 rounded-xl border border-slate-800">
                            <h3 className="text-sm uppercase text-slate-500 font-semibold mb-4 flex items-center gap-2"><Icons.Activity className="w-4 h-4" /> 재무 현황 (단위: 억원)</h3>
                            <div className="h-48 w-full">
                                <SafeResponsiveContainer width="100%" height="100%">
                                    <SafeBarChart data={chartData}>
                                        <SafeXAxis dataKey="name" stroke="#64748b" fontSize={12} tickLine={false} axisLine={false} />
                                        <SafeTooltip cursor={{fill: '#1e293b'}} contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', color: '#f1f5f9' }} formatter={(val)=>val.toLocaleString()} />
                                        <SafeBar dataKey="value" fill="#10b981" radius={[4, 4, 0, 0]} barSize={40} />
                                    </SafeBarChart>
                                </SafeResponsiveContainer>
                            </div>
                             <div className="grid grid-cols-3 gap-4 mt-4 pt-4 border-t border-slate-800">
                                <div><div className="text-xs text-slate-500">EBITDA 마진</div><div className="text-lg font-mono text-white">{opMargin}%</div></div>
                                <div><div className="text-xs text-slate-500">PER</div><div className="text-lg font-mono text-white">{company.per?.toFixed(1) ?? '-'}x</div></div>
                                <div><div className="text-xs text-slate-500">매출액</div><div className="text-lg font-mono text-white">{company.sales.toLocaleString()}</div></div>
                            </div>
                        </div>

                        <div>
                            <h3 className="text-sm uppercase text-slate-500 font-semibold mb-3 flex items-center gap-2"><Icons.FileText className="w-4 h-4" /> 사업 개요</h3>
                            <div className="bg-slate-800/50 p-4 rounded-xl text-slate-300 text-sm border border-slate-700 max-h-48 overflow-y-auto custom-scrollbar">{company.biz_description_raw}</div>
                        </div>

                        <div className="bg-gradient-to-b from-slate-900 to-slate-950 border border-emerald-500/30 rounded-xl p-6 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-cyan-500"></div>
                            <div className="flex flex-col gap-4 mb-4">
                                <div className="flex items-center justify-between">
                                    <h3 className="text-lg font-bold text-white flex items-center gap-2"><Icons.Bot className="w-5 h-5 text-emerald-400" /> Gemini 분석</h3>
                                    {!analysis && !loading && <button onClick={handleAnalyze} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-lg">분석 시작</button>}
                                </div>
                                {!analysis && !loading && (
                                    <div className="relative">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Icons.Key className="w-4 h-4 text-slate-500"/></div>
                                        <input type="password" placeholder="Gemini API Key (저장되지 않음)" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 pl-10 text-sm text-white focus:border-emerald-500 outline-none" />
                                        <p className="text-[10px] text-slate-500 mt-1 pl-1">* GitHub Pages와 같은 정적 환경에서는 보안을 위해 API Key를 직접 입력해야 합니다.</p>
                                    </div>
                                )}
                            </div>

                            {loading && <div className="flex flex-col items-center py-8 text-slate-400 animate-pulse"><Icons.Bot className="w-8 h-8 mb-3 opacity-50" /><p>분석중입니다...</p></div>}
                            {error && <div className="text-rose-400 bg-rose-950/30 p-4 rounded-lg text-sm border border-rose-900">{error}</div>}

                            {analysis && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="text-slate-300 italic text-sm border-l-2 border-emerald-500 pl-4 py-1">"{analysis.summary}"</div>
                                    <div><h4 className="text-emerald-400 text-xs font-bold uppercase mb-2 flex items-center gap-1"><Icons.TrendingUp className="w-3 h-3" /> 강점</h4><ul className="space-y-2">{analysis.strengths.map((s, i) => <li key={i} className="flex items-start gap-2 text-sm text-slate-300"><span className="mt-1.5 w-1 h-1 rounded-full bg-emerald-500 shrink-0"></span>{s}</li>)}</ul></div>
                                    <div><h4 className="text-rose-400 text-xs font-bold uppercase mb-2 flex items-center gap-1"><Icons.AlertTriangle className="w-3 h-3" /> 리스크</h4><ul className="space-y-2">{analysis.risks.map((r, i) => <li key={i} className="flex items-start gap-2 text-sm text-slate-300"><span className="mt-1.5 w-1 h-1 rounded-full bg-rose-500 shrink-0"></span>{r}</li>)}</ul></div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const CompanyTable = ({ data, onSelect }) => {
            const [page, setPage] = useState(1);
            const ITEMS = 20;
            const totalPages = Math.ceil(data.length / ITEMS);
            const currentData = data.slice((page-1)*ITEMS, page*ITEMS);

            useEffect(() => setPage(1), [data.length]);

            if (data.length === 0) return <div className="text-center py-20 bg-slate-800/50 rounded-xl border border-slate-700"><p className="text-slate-400">검색 결과가 없습니다.</p></div>;

            return (
                <div className="flex flex-col gap-4">
                    <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-lg overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-950 text-slate-400 uppercase font-semibold border-b border-slate-800">
                                <tr>
                                    <th className="px-6 py-4">기업명</th>
                                    <th className="px-6 py-4">업종</th>
                                    <th className="px-6 py-4 text-right">시가총액 (억원)</th>
                                    <th className="px-6 py-4 text-right">매출액 (억원)</th>
                                    <th className="px-6 py-4 text-right">EBITDA</th>
                                    <th className="px-6 py-4 text-right">PER</th>
                                    <th className="px-6 py-4 text-center">상세</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800">
                                {currentData.map((company) => {
                                    const opMargin = getOpMargin(company);
                                    return (
                                        <tr key={company.stock_code} onClick={() => onSelect(company)} className="hover:bg-slate-800/50 transition-colors cursor-pointer group">
                                            <td className="px-6 py-4">
                                                <div className="font-medium text-white group-hover:text-emerald-400">{company.corp_name}</div>
                                                <div className="text-xs text-slate-500 flex gap-1"><span className="px-1 rounded text-[10px] bg-blue-900/30 text-blue-400">KOSPI</span>{company.stock_code}</div>
                                            </td>
                                            <td className="px-6 py-4"><span className="px-2 py-1 rounded bg-slate-800 text-slate-300 text-xs border border-slate-700">{company.sector}</span></td>
                                            <td className="px-6 py-4 text-right font-mono text-emerald-100">{company.market_cap.toLocaleString()}</td>
                                            <td className="px-6 py-4 text-right font-mono text-slate-300">{company.sales.toLocaleString()}</td>
                                            <td className="px-6 py-4 text-right font-mono"><span className={opMargin>0?'text-emerald-400':'text-rose-400'}>{company.ebitda.toLocaleString()}</span></td>
                                            <td className="px-6 py-4 text-right font-mono text-slate-300">{company.per?.toFixed(1) || '-'}x</td>
                                            <td className="px-6 py-4 text-center"><button className="p-1.5 text-slate-400 group-hover:text-white"><Icons.ChevronRight className="w-4 h-4"/></button></td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    {totalPages > 1 && (
                        <div className="flex justify-between items-center px-2 text-slate-400 text-sm">
                            <span>{page} / {totalPages} 페이지</span>
                            <div className="flex gap-2">
                                <button disabled={page===1} onClick={()=>setPage(p=>p-1)} className="p-2 bg-slate-800 rounded disabled:opacity-50 hover:bg-slate-700"><Icons.ChevronLeft className="w-4 h-4"/></button>
                                <button disabled={page===totalPages} onClick={()=>setPage(p=>p+1)} className="p-2 bg-slate-800 rounded disabled:opacity-50 hover:bg-slate-700"><Icons.ChevronRight className="w-4 h-4"/></button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState(MOCK_DATA);
            const [selectedCompany, setSelectedCompany] = useState(null);
            const [showFilters, setShowFilters] = useState(false);
            const [filters, setFilters] = useState({ keyword: '', minOpMargin: 0, minSales: 0, market: 'ALL', size: 'ALL', mode: 'SMART' });

            const filteredData = useMemo(() => filterCompanies(data, filters), [data, filters]);

            const handleFileUpload = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        if (evt.target?.result) {
                            // Simple CSV parser for user uploaded files
                            const lines = evt.target.result.split('\n');
                            const parsed = [];
                            for(let i=1; i<lines.length; i++) {
                                const v = lines[i].split(',');
                                if(v.length > 5) parsed.push({
                                    corp_name: v[0], stock_code: v[1], market: 'KOSPI', sector: v[2],
                                    market_cap: parseFloat(v[3])||0, sales: parseFloat(v[4])||0, ebitda: parseFloat(v[5])||0,
                                    per: 0, biz_description_raw: v[6]||''
                                });
                            }
                            if (parsed.length > 0) setData(parsed);
                            else alert("CSV 형식 오류");
                        }
                    };
                    reader.readAsText(file);
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 text-slate-100 flex flex-col font-sans">
                    <header className="border-b border-slate-800 bg-slate-950/50 sticky top-0 z-40 backdrop-blur">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-emerald-500 p-1.5 rounded-lg"><Icons.Cpu className="w-6 h-6 text-white" /></div>
                                <h1 className="text-xl font-bold tracking-tight text-white">Peer<span className="text-emerald-400">Bot</span></h1>
                            </div>
                            <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div><span className="text-xs text-emerald-500">KOSPI 200 Ready</span></div>
                        </div>
                    </header>

                    <main className="flex-1 max-w-7xl w-full mx-auto px-4 py-8">
                        <div className="mb-8">
                            <div className="text-center mb-8">
                                <h2 className="text-3xl font-bold text-white mb-2">Find Your Peer Group</h2>
                                <p className="text-slate-400">KOSPI 200 기업을 재무 및 자연어로 스마트하게 검색하세요.</p>
                            </div>

                            <SearchBar 
                                value={filters.keyword} mode={filters.mode} 
                                onChange={(val) => setFilters(prev => ({...prev, keyword: val}))}
                                onModeChange={(m) => setFilters(prev => ({...prev, mode: m}))}
                                onToggleFilters={() => setShowFilters(!showFilters)} 
                            />

                            {showFilters && (
                                <div className="max-w-4xl mx-auto bg-slate-900 border border-slate-700 rounded-xl p-6 mb-8 shadow-xl animate-fade-in">
                                    <div className="flex items-center gap-2 mb-4 text-emerald-400 font-semibold uppercase text-xs tracking-wider"><Icons.Filter className="w-4 h-4" /> 상세 필터</div>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        <div>
                                            <label className="block text-sm text-slate-400 mb-2">시장 구분</label>
                                            <select className="w-full bg-slate-800 border border-slate-700 text-white rounded p-2.5" value={filters.market} onChange={(e) => setFilters(p => ({...p, market: e.target.value}))}>
                                                <option value="ALL">전체</option><option value="KOSPI">KOSPI</option><option value="KOSDAQ">KOSDAQ</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-slate-400 mb-2">기업 규모 (시가총액)</label>
                                            <select className="w-full bg-slate-800 border border-slate-700 text-white rounded p-2.5" value={filters.size} onChange={(e) => setFilters(p => ({...p, size: e.target.value}))}>
                                                <option value="ALL">전체</option><option value="LARGE">대형주 (10조↑)</option><option value="MID">중형주 (1조~10조)</option><option value="SMALL">소형주 (1조↓)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-slate-400 mb-2">최소 매출액 (억원)</label>
                                            <input type="number" className="w-full bg-slate-800 border border-slate-700 text-white rounded p-2.5" value={filters.minSales} onChange={(e) => setFilters(p => ({...p, minSales: Number(e.target.value)}))} />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-slate-400 mb-2">최소 마진율 (%)</label>
                                            <div className="flex items-center gap-3">
                                                <input type="range" min="0" max="50" className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500" value={filters.minOpMargin} onChange={(e) => setFilters(p => ({...p, minOpMargin: Number(e.target.value)}))} />
                                                <span className="text-white font-mono w-10 text-right">{filters.minOpMargin}%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="flex justify-between items-center text-sm text-slate-500 mb-4 px-2">
                                <div>검색 결과: <span className="text-white font-bold">{filteredData.length}</span> 개 기업</div>
                                <label className="flex items-center gap-2 cursor-pointer hover:text-emerald-400 transition-colors">
                                    <Icons.Upload className="w-4 h-4" /><span>CSV 데이터 업로드</span><input type="file" accept=".csv" className="hidden" onChange={handleFileUpload} />
                                </label>
                            </div>
                        </div>

                        <CompanyTable data={filteredData} onSelect={setSelectedCompany} />

                        {selectedCompany && (
                            <>
                                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-40" onClick={() => setSelectedCompany(null)}></div>
                                <DetailPanel company={selectedCompany} onClose={() => setSelectedCompany(null)} />
                            </>
                        )}
                    </main>

                    <footer className="border-t border-slate-800 py-6 text-center text-slate-500 text-sm">
                        <p>PeerBot &copy; 2025. Powered by Dart-FSS & Gemini.</p>
                        <p className="mt-1">제공: Doohyun KIM & Soojeong YEON</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
